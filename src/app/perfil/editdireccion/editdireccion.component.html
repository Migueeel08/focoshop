<div class="edit-direccion-container">
  <header class="edit-header">
    <div class="logo">
      <span class="logo-text">FOCOSHOP</span>
      <i class="fa fa-shopping-cart"></i>
    </div>

    <button (click)="volver()" class="btn-volver-header">
      <i class="fa fa-arrow-left"></i> Volver
    </button>
  </header>

  <main class="edit-content">
    <div class="form-card">
      <div class="form-header">
        <i class="fa fa-map-marker-alt"></i>
        <h2>Editar Dirección de Envío</h2>
      </div>

      <form class="direccion-form" (ngSubmit)="guardarDireccion()">
        <!-- Información del usuario (solo lectura) -->
        <div class="seccion-info">
          <h3><i class="fa fa-user"></i> Información de Contacto</h3>
          <div class="form-row">
            <div class="form-group readonly full-width">
              <label>Nombre Completo</label>
              <input 
                type="text" 
                [value]="user.nombre + ' ' + user.apellido"
                disabled
                class="input-readonly"
              />
            </div>
          </div>

          <div class="form-row">
            <div class="form-group readonly">
              <label><i class="fa fa-envelope"></i> Correo Electrónico</label>
              <input 
                type="email" 
                [value]="user.email"
                disabled
                class="input-readonly"
              />
            </div>

            <div class="form-group readonly">
              <label><i class="fa fa-phone"></i> Teléfono</label>
              <input 
                type="tel" 
                [value]="user.telefono"
                disabled
                class="input-readonly"
              />
            </div>
          </div>
        </div>

        <!-- Dirección -->
        <div class="seccion-direccion">
          <h3><i class="fa fa-home"></i> Dirección de Entrega</h3>
          
          <!-- País -->
          <div class="form-row">
            <div class="form-group full-width">
              <label><i class="fa fa-globe"></i> País <span class="required">*</span></label>
              <select 
                [(ngModel)]="direccion.pais"
                name="pais"
                (change)="onPaisChange()"
                required
                class="input-field"
              >
                <option *ngFor="let pais of paises" [value]="pais">{{ pais }}</option>
              </select>
            </div>
          </div>

          <!-- Código Postal con búsqueda automática -->
          <div class="form-row">
            <div class="form-group">
              <label><i class="fa fa-search"></i> Código Postal <span class="required">*</span></label>
              <div class="cp-input-container">
                <input 
                  type="text" 
                  [(ngModel)]="direccion.codigoPostal"
                  name="codigoPostal"
                  placeholder="Ej: 12345"
                  maxlength="5"
                  (blur)="buscarPorCodigoPostal()"
                  (keyup.enter)="buscarPorCodigoPostal()"
                  required
                  class="input-field"
                  [class.input-success]="cpEncontrado"
                  [class.input-error]="errorCP"
                />
                @if (buscandoCP) {
                  <span class="cp-loading"><i class="fa fa-spinner fa-spin"></i></span>
                }
                @if (cpEncontrado) {
                  <span class="cp-success"><i class="fa fa-check-circle"></i></span>
                }
                @if (errorCP) {
                  <span class="cp-error"><i class="fa fa-exclamation-circle"></i></span>
                }
              </div>
              @if (cpEncontrado && direccion.pais === 'México') {
                <small class="helper-text success">✓ Código postal válido - Casillas llenadas automaticamente</small>
              }
              @if (errorCP) {
                <small class="helper-text error">⚠ Código postal no encontrado, completa manualmente</small>
              }
            </div>

            <div class="form-group">
              <label>Estado <span class="required">*</span></label>
              <select 
                [(ngModel)]="direccion.estado"
                name="estado"
                required
                class="input-field"
                [disabled]="cpEncontrado && direccion.pais === 'México'"
              >
                <option value="">Selecciona un estado</option>
                <option *ngFor="let estado of estadosDisponibles" [value]="estado.nombre">
                  {{ estado.nombre }}
                </option>
              </select>
            </div>
          </div>

          <!-- Ciudad y Colonia -->
          <div class="form-row">
            <div class="form-group">
              <label>Ciudad / Municipio <span class="required">*</span></label>
              <input 
                type="text" 
                [(ngModel)]="direccion.ciudad"
                name="ciudad"
                placeholder="Ej: Guadalajara"
                required
                class="input-field"
                [readonly]="cpEncontrado && direccion.pais === 'México'"
              />
            </div>

            <div class="form-group">
              <label>Colonia <span class="required">*</span></label>
              @if (colonias.length > 0) {
                <select 
                  [(ngModel)]="direccion.colonia"
                  name="colonia"
                  required
                  class="input-field"
                >
                  <option value="">Selecciona una colonia</option>
                  <option *ngFor="let colonia of colonias" [value]="colonia">
                    {{ colonia }}
                  </option>
                </select>
              } @else {
                <input 
                  type="text" 
                  [(ngModel)]="direccion.colonia"
                  name="colonia"
                  placeholder="Ej: Centro"
                  required
                  class="input-field"
                />
              }
            </div>
          </div>

          <!-- Calle y Números -->
          <div class="form-row">
            <div class="form-group full-width">
              <label>Calle <span class="required">*</span></label>
              <input 
                type="text" 
                [(ngModel)]="direccion.calle"
                name="calle"
                placeholder="Ej: Av. Revolución"
                required
                class="input-field"
              />
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Número Exterior <span class="required">*</span></label>
              <input 
                type="text" 
                [(ngModel)]="direccion.numeroExterior"
                name="numeroExterior"
                placeholder="Ej: 123"
                required
                class="input-field"
              />
            </div>

            <div class="form-group">
              <label>Número Interior <span class="opcional">(Opcional)</span></label>
              <input 
                type="text" 
                [(ngModel)]="direccion.numeroInterior"
                name="numeroInterior"
                placeholder="Ej: Depto 4B"
                class="input-field"
              />
            </div>
          </div>

          <!-- Referencias -->
          <div class="form-row">
            <div class="form-group full-width">
              <label>Referencias de entrega <span class="opcional">(Opcional)</span></label>
              <textarea 
                [(ngModel)]="direccion.referencias"
                name="referencias"
                placeholder="Ej: Casa de color blanco, portón negro, entre calle X y Y"
                rows="3"
                class="input-field textarea"
              ></textarea>
            </div>
          </div>
        </div>

        <!-- Botones -->
        <div class="form-actions">
          <button type="button" (click)="volver()" class="btn-cancelar">
            <i class="fa fa-times"></i> Cancelar
          </button>
          <button type="submit" class="btn-guardar">
            <i class="fa fa-save"></i> Guardar Dirección
          </button>
        </div>
      </form>
    </div>
  </main>
</div>

<!-- Alerta de éxito -->
@if (mostrarAlerta) {
  <div class="alerta-exitosa">
    <div class="alerta-contenido">
      <i class="fa fa-check-circle"></i>
      <p>{{ mensajeAlerta }}</p>
    </div>
  </div>
}